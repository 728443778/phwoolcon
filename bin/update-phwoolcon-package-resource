#!/usr/bin/env php
<?php
/**
 * This file will be copied into directory "vendor/bin" after installation
 */

use Phwoolcon\Cache;
use Phwoolcon\Config;
use Phwoolcon\Db;
use Phwoolcon\DiFix;
use Phwoolcon\Events;

error_reporting(-1);

$baseDir = dirname(dirname(__DIR__));
if (!is_dir($baseDir . '/vendor/phwoolcon')) {
    $baseDir = $_SERVER['PWD'];
}
$vendorDir = $baseDir . '/vendor';

ob_start();
try {
    include $baseDir . '/bootstrap/start.php';
    $firstRun = false;
} catch (Exception $e) {
    $firstRun = true;
}
ob_end_clean();

if ($firstRun) {
    $assetsBasePath = $baseDir . '/public';
    $assetsDir = 'assets';
    $replaceConfig = true;
} else {
    Events::register($di);
    DiFix::register($di);
    Db::register($di);
    Cache::register($di);
    Config::register($di);
    $assetsBasePath = Config::get('view.options.assets_options.base_path', $baseDir . '/public');
    $assetsDir = Config::get('view.options.assets_options.assets_dir', 'assets');
    $replaceConfig = Config::get('app.on_phwoolcon_update.replace_config');
}

if (!function_exists('fileSaveArray')) {
    /**
     * @param string $filename
     * @param mixed  $array
     * @return int
     */
    function fileSaveArray($filename, $array)
    {
        return file_put_contents($filename, '<?php return ' . var_export($array, true) . ';');
    }
}

$configPath = $_SERVER['PHWOOLCON_CONFIG_PATH'];
$assetsPath = $assetsBasePath . '/' . $assetsDir . '/base/packages';
is_dir($configPath) or mkdir($configPath, 0777, true);
is_dir($assetsPath) or mkdir($assetsPath, 0777, true);

$packages = [];
$packageFiles = glob($vendorDir . '/bin/phwoolcon-package-*.php');

$diFiles = [];
$routeFiles = [];
$commands = [];
$aliases = [];

foreach ($packageFiles as $file) {
    if (!is_array($package = include($file))) {
        continue;
    }
    foreach ($package as $name => $resources) {
        $path = $vendorDir . '/' . $name;
        foreach ($resources as $type => $value) {
            switch ($type) {
                case 'config':
                    installConfig($name, $path, $value, $configPath, $replaceConfig);
                    break;
                case 'assets':
                    installAssets($name, $path, $value, $assetsPath);
                    break;
                case 'di':
                    installDi($name, $path, $value, $diFiles);
                    break;
                case 'routes':
                    installRoutes($name, $path, $value, $routeFiles);
                    break;
                case 'commands':
                    if (is_array($value)) {
                        $commands = array_merge_recursive($commands, $value);
                        echo sprintf('[%s]%s Installed commands', $name, spacePad($name)), PHP_EOL;
                    }
                    break;
                case 'class_aliases':
                    if (is_array($value)) {
                        $aliases = array_merge_recursive($aliases, $value);
                        echo sprintf('[%s]%s Registered class aliases', $name, spacePad($name)), PHP_EOL;
                    }
                    break;
            }
        }
    }
}
writeDi($diFiles);
writeRoutes($routeFiles);
writeCommands($commands);
writeAliases($aliases);

function installConfig($package, $path, $file, $configPath, $replaceConfig = false)
{
    if (is_array($file)) {
        foreach ($file as $subFile) {
            installConfig($package, $path, $subFile, $configPath, $replaceConfig);
        }
        return;
    }
    if ([strpos($file, '..'), strpos($file, '/'), strpos($file, '\\')] != [false, false, false]) {
        return;
    }
    if (!is_file($source = $path . '/phwoolcon-package/config/' . $file)) {
        return;
    }
    $destination = $configPath . '/' . $file;
    $installed = is_file($destination);
    if (($replaceConfig || !$installed) && copy($source, $destination)) {
        echo sprintf('[%s]%s Installed config file %s', $package, spacePad($package), $file), PHP_EOL;
    }
}

function installAssets($package, $path, $file, $assetsPath)
{
    static $fileCount;
    if (is_array($file)) {
        foreach ($file as $subFile) {
            installAssets($package, $path, $subFile, $assetsPath);
        }
        return;
    }
    if (strpos($file, '..') !== false) {
        return;
    }
    $source = $path . '/phwoolcon-package/assets/' . $file;
    if (is_dir($source)) {
        foreach (scandir($source) as $subFile) {
            if ($subFile == '.' || $subFile == '..') {
                continue;
            }
            installAssets($package, $path, $file . '/' . $subFile, $assetsPath);
        }
        return;
    }
    if (!is_file($source)) {
        return;
    }
    $destination = $assetsPath . '/' . $file;
    is_dir($dir = dirname($destination)) or mkdir($dir, 0777, true);
    if (copy($source, $destination)) {
        isset($fileCount[$package]) or $fileCount[$package] = 0;
        ++$fileCount[$package];
        if ($fileCount[$package] < 3) {
            echo sprintf('[%s]%s Updated assets file %s', $package, spacePad($package), $file), PHP_EOL;
        } else if ($fileCount[$package] < 6) {
            echo str_repeat(' ', 23), '.', PHP_EOL;
        }
    }
}

function installDi($package, $path, $file, &$diFiles = [], $sort = null)
{
    if (is_array($file)) {
        foreach ($file as $realSort => $realFile) {
            installDi($package, $path, $realFile, $diFiles, $realSort);
        }
        return;
    }
    echo sprintf('[%s]%s DI registered', $package, spacePad($package)), PHP_EOL;
    $diFiles[$sort][] = $path . '/phwoolcon-package/' . $file;
}

function installRoutes($package, $path, $file, &$routeFiles = [], $sort = null)
{
    if (is_array($file)) {
        foreach ($file as $realSort => $realFile) {
            installRoutes($package, $path, $realFile, $routeFiles, $realSort);
        }
        return;
    }
    echo sprintf('[%s]%s Routes registered', $package, spacePad($package)), PHP_EOL;
    $routeFiles[$sort][] = $path . '/phwoolcon-package/' . $file;
}

function installCommands($package, $detected, &$commands = [])
{
    $commands = array_merge($commands, $detected);
    echo sprintf('[%s]%s Installed commands', $package, spacePad($package)), PHP_EOL;
}

function installClassAliases($package, $detected, &$aliases = [])
{
    $aliases = array_merge($aliases, $detected);
    echo sprintf('[%s]%s Installed commands', $package, spacePad($package)), PHP_EOL;
}

function writeDi($diFiles)
{
    $target = $GLOBALS['vendorDir'] . '/phwoolcon/di.php';
    fileSaveInclude($target, sortAndFlattenArray($diFiles));
}

function writeRoutes($routeFiles)
{
    $target = $GLOBALS['vendorDir'] . '/phwoolcon/routes.php';
    fileSaveInclude($target, sortAndFlattenArray($routeFiles));
}

function writeCommands($commands)
{
    $target = $GLOBALS['vendorDir'] . '/phwoolcon/commands.php';
    fileSaveArray($target, sortAndFlattenArray($commands));
}

function writeAliases($aliases)
{
    $target = $GLOBALS['vendorDir'] . '/phwoolcon/class_aliases.php';
    fileSaveArray($target, sortAndFlattenArray($aliases));
}

function sortAndFlattenArray($array)
{
    ksort($array);
    $flatArray = [];
    foreach ($array as $item) {
        $flatArray = array_merge($flatArray, $item);
    }
    return $flatArray;
}

function fileSaveInclude($target, array $includes)
{
    $content = '<?php' . PHP_EOL;
    foreach ($includes as $file) {
        $content .= "include '{$file}';" . PHP_EOL;
    }
    file_put_contents($target, $content);
}

function spacePad($str, $length = 20)
{
    $spaces = $length - strlen($str);
    return $spaces > 0 ? str_repeat(' ', $spaces) : ' ';
}
